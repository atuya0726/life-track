# 機能仕様書

## 0. アプリケーション基本設計

### アーキテクチャ
- **アプリケーションタイプ**: SPA (Single Page Application)
- **フレームワーク**: Next.js (App Router)
- **状態管理**: クライアントサイドの状態管理
  - ユーザーセッション
  - 実績データのキャッシュ
  - フォーム状態

### クライアントサイドの実装
- **ルーティング**:
  - クライアントサイドナビゲーション
  - ページ遷移時のローディング表示
  - 動的なルートパラメータ処理
- **データフェッチ**:
  - APIエンドポイントからのデータ取得
  - キャッシュの活用
  - 楽観的UI更新
- **インタラクション**:
  - フォームの非同期送信
  - リアルタイムバリデーション
  - スムーズなページ遷移

### APIエンドポイント
- **ベースURL**: `/api`
- **レスポンス形式**: JSON
- **認証**: JWTトークン（Authorization header）
- **エンドポイント一覧**:
  ```typescript
  // 認証関連
  POST /api/auth/login
  POST /api/auth/signup
  POST /api/auth/logout

  // 実績関連
  GET /api/achievements
  POST /api/achievements/complete
  POST /api/achievements/custom
  GET /api/achievements/user
  ```

## 1. 認証機能

### ログイン機能
- **概要**: ユーザーがメールアドレスとパスワードでログインする
- **エンドポイント**: `/login`
- **機能詳細**:
  - メールアドレスとパスワードによる認証
  - 認証成功時はダッシュボードへリダイレクト
  - エラー時は適切なエラーメッセージを表示
- **バリデーション**:
  - メールアドレス: 有効なメールアドレス形式
  - パスワード: 1文字以上
- **エラーハンドリング**:
  - 無効なメールアドレス/パスワード
  - アカウントが存在しない
  - ネットワークエラー

### 新規登録機能
- **概要**: 新規ユーザーの登録
- **エンドポイント**: `/signup`
- **機能詳細**:
  - メールアドレス、パスワード、ユーザー名の登録
  - 登録成功時はメール確認ページへリダイレクト
- **バリデーション**:
  - メールアドレス: 有効なメールアドレス形式
  - パスワード: 8文字以上、大文字小文字数字を含む
  - ユーザー名: 3-20文字

## 2. 実績管理機能

### 実績達成の記録
- **概要**: ユーザーが達成した実績を記録する
- **エンドポイント**: `/api/achievements/complete`
- **機能詳細**:
  - 既存の実績から選択して達成を記録
  - 達成日時とメモを記録可能
  - 同じ実績の重複達成は不可
- **データ構造**:
  ```typescript
  interface AchievementCompletion {
    achievement_id: string;
    note?: string;
    completed_at: Date;
  }
  ```
- **エラーハンドリング**:
  - 既に達成済みの実績
  - 存在しない実績ID
  - 権限エラー

### カスタム実績の作成
- **概要**: ユーザーが独自の実績を作成する
- **エンドポイント**: `/api/achievements/custom`
- **機能詳細**:
  - タイトルと説明文を設定
  - 作成者のみが管理可能
  - システム実績をベースに拡張可能
- **データ構造**:
  ```typescript
  interface CustomAchievement {
    title: string;
    description?: string;
    custom_achievement: true;
    base_achievement_id?: string; // 拡張元の実績ID（任意）
  }
  ```
- **バリデーション**:
  - タイトル: 必須、1-100文字
  - 説明: 任意、0-500文字
- **エラーハンドリング**:
  - 無効なタイトル/説明
  - 拡張元の実績が存在しない
  - 権限エラー

## 3. 実績表示機能

### ダッシュボード
- **概要**: ユーザーの実績一覧を表示
- **エンドポイント**: `/dashboard`
- **機能詳細**:
  - 達成済み実績の一覧表示
  - カスタム実績の表示
  - 達成日時とメモの表示
- **表示項目**:
  - 実績タイトル
  - 説明文
  - 達成日時
  - メモ
  - カスタム実績フラグ
- **ソート機能**:
  - 達成日時順
  - タイトル順
- **フィルター機能**:
  - システム実績/カスタム実績
  - 達成済み/未達成

## 4. エラーハンドリング共通仕様

### エラーレスポンス形式
```typescript
interface ErrorResponse {
  code: string;
  message: string;
  details?: any;
}
```

### 主要エラーコード
- `AUTH_ERROR`: 認証関連のエラー
- `VALIDATION_ERROR`: バリデーションエラー
- `NOT_FOUND`: リソースが見つからない
- `PERMISSION_ERROR`: 権限エラー
- `DUPLICATE_ERROR`: 重複エラー
- `SYSTEM_ERROR`: システムエラー
